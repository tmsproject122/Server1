name: Continuous Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      
    - name: Display startup info
      run: |
        echo "Creating hostname root@incre"
        echo "Creating username incre and pass Incre.com"
        
    - name: Set hostname
      run: |
        sudo hostnamectl set-hostname root@incre
        echo "127.0.0.1 root@incre" | sudo tee -a /etc/hosts
        
    - name: Set root password
      run: |
        echo "root:Incre.com" | sudo chpasswd
        
    - name: Create user 'incre' with password 'Incre.com'
      run: |
        if ! id -u incre >/dev/null 2>&1; then
          sudo useradd -m -s /bin/bash incre
          echo "incre:Incre.com" | sudo chpasswd
          sudo usermod -aG sudo incre
          echo "incre ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/incre
        fi
        
    - name: Install prerequisites
      run: |
        sudo apt update
        sudo apt install -y tmux curl unzip sudo net-tools neofetch openssh-server
        
    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        
    - name: Restore backup files
      run: |
        if [ -f ./backup/backup.zip ]; then
          unzip -o ./backup/backup.zip -d /
        else
          echo "No backup found, starting fresh"
        fi
        
    - name: Restore Tailscale state
      run: |
        if [ -f /opt/vps-backup/data/tailscaled.state ]; then
          sudo mkdir -p /var/lib/tailscale
          sudo cp /opt/vps-backup/data/tailscaled.state /var/lib/tailscale/tailscaled.state
          sudo chmod 600 /var/lib/tailscale/tailscaled.state
        fi
        
    - name: Start Tailscale
      run: |
        sudo tailscaled &
        sleep 8
        sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=root@incre || echo "Tailscale already up"
        
    - name: Setup SSH access
      run: |
        # Install and configure SSH server
        sudo apt install -y openssh-server
        sudo systemctl start ssh
        sudo systemctl enable ssh
        
        # Get public IP (for information)
        PUBLIC_IP=$(curl -s ifconfig.me || echo "unknown")
        echo "Public IP: $PUBLIC_IP"
        
    - name: Create persistent tmux session
      run: |
        # Create a named tmux session that persists
        tmux new-session -d -s vps-session -c /home/incre
        tmux send-keys -t vps-session "echo 'VPS Session Started - $(date)'" Enter
        tmux send-keys -t vps-session "echo 'Tailscale IP:'" Enter
        tmux send-keys -t vps-session "tailscale ip -4" Enter
        tmux send-keys -t vps-session "echo ''" Enter
        tmux send-keys -t vps-session "echo 'Use: tmux attach -t vps-session' to connect'" Enter
        
        echo "âœ… tmux session created: vps-session"
        
    - name: Show connection information
      run: |
        echo "=============================================="
        echo "ðŸš€ VPS READY FOR CONNECTIONS"
        echo "=============================================="
        echo ""
        echo "ðŸ”— Tailscale IP (for direct access):"
        tailscale ip -4 || echo "Tailscale IP not found"
        echo ""
        echo "ðŸ’» Connect via Tailscale:"
        echo "  ssh incre@$(tailscale ip -4)"
        echo ""
        echo "ðŸ“‹ To access the tmux session:"
        echo "  tmux attach -t vps-session"
        echo ""
        echo "ðŸ”§ VPS will auto-reconnect every 6 hours"
        echo "=============================================="
        
    - name: Setup auto-reconnect and monitoring
      run: |
        # Create monitoring script
        cat > /tmp/monitor_vps.sh << 'EOF'
        #!/bin/bash
        while true; do
          echo "[$(date)] VPS running - Tailscale: $(tailscale ip -4 2>/dev/null || echo 'disconnected')"
          sleep 300
        done
        EOF
        
        chmod +x /tmp/monitor_vps.sh
        nohup /tmp/monitor_vps.sh > /tmp/vps_monitor.log 2>&1 &
        
    - name: Backup VPS data and tailscale state
      run: |
        echo "Creating backup..."
        sudo mkdir -p /opt/vps-backup/data
        sudo cp /var/lib/tailscale/tailscaled.state /opt/vps-backup/data/ 2>/dev/null || echo "No tailscale state found"
        sudo chown -R $USER:$USER /opt/vps-backup
        zip -r backup.zip /opt/vps-backup
        
    - name: Upload VPS backup artifact
      uses: actions/upload-artifact@v4
      with:
        name: vps-backup
        path: backup.zip
        
    - name: Keep workflow running
      run: |
        echo "âœ… VPS is running with Tailscale and tmux session"
        echo "ðŸ’» Connect using Tailscale IP: $(tailscale ip -4)"
        echo "ðŸ“‹ Access tmux session: tmux attach -t vps-session"
        echo ""
        echo "The VPS will remain active for 350 minutes (6 hours)"
        echo "Monitoring is running in background..."
        
        # Wait for the timeout or manual cancellation
        sleep 21000  # 350 minutes

# Username = incre
# Pass = Incre.com
