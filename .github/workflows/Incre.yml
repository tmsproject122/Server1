name: Continuous Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      
    - name: Display startup info
      run: |
        echo "Creating hostname root@incre"
        echo "Creating username incre and pass Incre.com"
        
    - name: Set hostname
      run: |
        sudo hostnamectl set-hostname root@incre
        echo "127.0.0.1 root@incre" | sudo tee -a /etc/hosts
        
    - name: Set root password
      run: |
        echo "root:Incre.com" | sudo chpasswd
        
    - name: Create user 'incre' with password 'Incre.com'
      run: |
        if ! id -u incre >/dev/null 2>&1; then
          sudo useradd -m -s /bin/bash incre
          echo "incre:Incre.com" | sudo chpasswd
          sudo usermod -aG sudo incre
          echo "incre ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/incre
        fi
        
    - name: Install prerequisites
      run: |
        sudo apt update
        sudo apt install -y tmate curl unzip sudo net-tools neofetch
        
    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        
    - name: Restore backup files
      run: |
        if [ -f ./backup/backup.zip ]; then
          unzip -o ./backup/backup.zip -d /
        else
          echo "No backup found, starting fresh"
        fi
        
    - name: Restore Tailscale state
      run: |
        if [ -f /opt/vps-backup/data/tailscaled.state ]; then
          sudo mkdir -p /var/lib/tailscale
          sudo cp /opt/vps-backup/data/tailscaled.state /var/lib/tailscale/tailscaled.state
          sudo chmod 600 /var/lib/tailscale/tailscaled.state
        fi
        
    - name: Start Tailscale
      run: |
        sudo tailscaled &
        sleep 8
        sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=root@incre || echo "Tailscale already up"
        
    - name: Start tmate session in background
      run: |
        # Start tmate in the background and capture connection info
        tmate -S /tmp/tmate.sock new-session -d
        tmate -S /tmp/tmate.sock wait tmate-ready
        tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' > /tmp/tmate_ssh
        tmate -S /tmp/tmate.sock display -p '#{tmate_web}' > /tmp/tmate_web
        
        # Display connection info
        echo "ðŸ”— tmate SSH: $(cat /tmp/tmate_ssh)"
        echo "ðŸŒ tmate Web: $(cat /tmp/tmate_web)"
        
        # Keep tmate running in background
        sleep 10 &
        
    - name: Show Tailscale IP and tmate info
      run: |
        echo "ðŸ”— Tailscale IP:"
        tailscale ip -4 || echo "Tailscale IP not found"
        echo ""
        echo "ðŸ”‘ tmate SSH session:"
        cat /tmp/tmate_ssh || echo "tmate SSH info not available"
        echo ""
        echo "ðŸŒ tmate Web session:"
        cat /tmp/tmate_web || echo "tmate Web info not available"
        
    - name: Sleep to keep VPS alive (background)
      run: |
        # Sleep in background to allow other steps to run
        sleep 21600 &
        
    - name: Backup VPS data and tailscale state
      run: |
        echo "Creating backup..."
        sudo mkdir -p /opt/vps-backup/data
        sudo cp /var/lib/tailscale/tailscaled.state /opt/vps-backup/data/ 2>/dev/null || echo "No tailscale state found"
        sudo chown -R $USER:$USER /opt/vps-backup
        zip -r backup.zip /opt/vps-backup
        
    - name: Upload VPS backup artifact
      uses: actions/upload-artifact@v4
      with:
        name: vps-backup
        path: backup.zip
        
    - name: Keep workflow running
      run: |
        echo "VPS is running with tmate session in background"
        echo "Workflow will continue to execute other steps"
        echo "Use the tmate connection info above to access your VPS"
        
        # Wait for background processes (tmate and sleep)
        wait

# Username = incre
# Pass = Incre.com
