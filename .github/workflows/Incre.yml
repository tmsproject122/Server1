name: Continuous Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      
    - name: Display startup info
      run: |
        echo "Creating hostname incre-vps"
        echo "Creating username incre and pass Incre.com"
        
    - name: Set hostname
      run: |
        sudo hostnamectl set-hostname incre-vps
        echo "127.0.0.1 incre-vps" | sudo tee -a /etc/hosts
        
    - name: Set root password
      run: |
        echo "root:Incre.com" | sudo chpasswd
        
    - name: Create user 'incre' with password 'Incre.com'
      run: |
        if ! id -u incre >/dev/null 2>&1; then
          sudo useradd -m -s /bin/bash incre
          echo "incre:Incre.com" | sudo chpasswd
          sudo usermod -aG sudo incre
          echo "incre ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/incre
        fi
        
    - name: Install prerequisites
      run: |
        sudo apt update
        sudo apt install -y tmate curl unzip sudo net-tools neofetch
        
    - name: Clean up existing Tailscale and install fresh
      run: |
        # Kill any existing tailscale processes
        sudo pkill -f tailscaled || true
        sudo rm -f /var/run/tailscale/tailscaled.sock 2>/dev/null || true
        
        # Install Tailscale fresh
        curl -fsSL https://tailscale.com/install.sh | sh
        
    - name: Restore backup files
      run: |
        if [ -f ./backup/backup.zip ]; then
          unzip -o ./backup/backup.zip -d /
        else
          echo "No backup found, starting fresh"
        fi
        
    - name: Restore Tailscale state
      run: |
        if [ -f /opt/vps-backup/data/tailscaled.state ]; then
          sudo mkdir -p /var/lib/tailscale
          sudo cp /opt/vps-backup/data/tailscaled.state /var/lib/tailscale/tailscaled.state
          sudo chmod 600 /var/lib/tailscale/tailscaled.state
        fi
        
    - name: Start Tailscale properly
      run: |
        # Start tailscaled with clean state
        sudo tailscaled --state=/var/lib/tailscale/tailscaled.state > /tmp/tailscaled.log 2>&1 &
        sleep 10
        
        # Bring up Tailscale with proper hostname
        sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=incre-vps --accept-routes
        
        echo "âœ… Tailscale started successfully"
        echo "Tailscale IP: $(tailscale ip -4 2>/dev/null || echo 'getting IP...')"
        
    - name: Start tmate session
      id: tmate
      uses: mxschmitt/action-tmate@v3
      with:
        timeout: 21000  # 350 minutes
        
    - name: Show connection information
      run: |
        echo "=============================================="
        echo "ðŸš€ VPS READY FOR CONNECTIONS"
        echo "=============================================="
        echo ""
        echo "ðŸ”— Tailscale IP:"
        tailscale ip -4 || echo "Tailscale IP not available yet"
        echo ""
        echo "ðŸ”‘ tmate SSH session:"
        echo "ssh $(cat $HOME/.tmate.sock/ssh 2>/dev/null | head -1 || echo 'tmate session starting...')"
        echo ""
        echo "ðŸŒ tmate Web session:"
        echo "https://tmate.io/t/$(cat $HOME/.tmate.sock/ssh 2>/dev/null | cut -d'@' -f1 || echo 'tmate session starting...')"
        echo ""
        echo "ðŸ’» Direct Tailscale SSH:"
        echo "ssh incre@$(tailscale ip -4 2>/dev/null || echo 'waiting-for-ip')"
        echo "Password: Incre.com"
        echo "=============================================="
        
    - name: Keep VPS alive
      run: |
        echo "VPS is running with tmate and Tailscale..."
        echo "Session will auto-reconnect every 6 hours"
        
        # Wait for the session to complete
        sleep 21600
        
    - name: Backup VPS data and tailscale state
      run: |
        echo "Creating backup before shutdown..."
        sudo mkdir -p /opt/vps-backup/data
        sudo cp /var/lib/tailscale/tailscaled.state /opt/vps-backup/data/ 2>/dev/null || echo "No tailscale state found"
        sudo chown -R $USER:$USER /opt/vps-backup
        zip -r backup.zip /opt/vps-backup
        
    - name: Upload VPS backup artifact
      uses: actions/upload-artifact@v4
      with:
        name: vps-backup
        path: backup.zip

# Username = incre
# Pass = Incre.com
